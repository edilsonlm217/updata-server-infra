version: '3.8'

services:
  elasticsearch:
    container_name: elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4  # ğŸ”„ VersÃ£o estÃ¡vel recente
    networks:
      - internal_network  # ğŸ•¸ï¸ ComunicaÃ§Ã£o privada entre serviÃ§os (ex: com Kibana)
    environment:
      - discovery.type=single-node  # ğŸ§ª Indica que Ã© um cluster de nÃ³ Ãºnico (sem discovery multicast)
      - bootstrap.memory_lock=true  # ğŸš« Impede que o sistema use swap para o processo do ES (melhora performance)
      - xpack.security.enabled=true  # ğŸ” Habilita autenticaÃ§Ã£o com usuÃ¡rio/senha e outras features de seguranÃ§a
      - ELASTIC_PASSWORD=admin123  # ğŸ‘¤ Define a senha do superusuÃ¡rio "elastic" (caso nÃ£o defina, ES gera uma aleatÃ³ria no log)
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"  # ğŸ§  Reserva 2GB de heap para a JVM (ideal que ambos valores sejam iguais)
    ulimits:
      memlock:
        soft: -1
        hard: -1  # âœ… Permite o uso do travamento de memÃ³ria com `bootstrap.memory_lock`
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data  # ğŸ’¾ PersistÃªncia dos dados entre reinÃ­cios
    restart: always  # ğŸ” Garante que reinicie automaticamente em caso de falhas

  kibana:
    container_name: kibana
    image: docker.elastic.co/kibana/kibana:8.13.4  # Atualizar para 8.x
    networks:
      - internal_network
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic                  # UsuÃ¡rio configurado no ES
      - ELASTICSEARCH_PASSWORD=admin123                  # Senha configurada no ES
    restart: always

volumes:
  elasticsearch_data:
    driver: local  # ğŸ“¦ Volume local padrÃ£o para persistÃªncia de dados

networks:
  internal_network:
    external: true  # ğŸŒ Presume que a rede jÃ¡ existe (criada fora do compose)
